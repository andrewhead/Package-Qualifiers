---
- name: Transfer list of queries
  copy: src=queries.txt dest={{ code_data }}/queries.txt

- name: Fetch search engine credentials
  s3: bucket={{ privatebucket }} object=google-credentials.json dest={{ src }}/google-credentials.json mode=get
      aws_access_key={{ aws_access_key_id }} aws_secret_key={{ aws_secret_access_key }}

- name: Launch job for fetching search results
  command: >
    {{ projectdir }}/venv/bin/python
    {{ src }}/fetch/fetch.py
    results
    {{ code_data }}/queries.txt
    {{ src }}/google-credentials.json
    --db postgres
    --db-config {{ src }}/{{ postgres_config }}
  async: "{{ long_time }}"
  poll: 0
  register: fetcher_sleeper

- name: Fail if job already exited.  If failure, this job may already be running.
  async_status: jid={{ fetcher_sleeper.ansible_job_id }}
  register: job_result
  failed_when: job_result.finished
  retries: 1
